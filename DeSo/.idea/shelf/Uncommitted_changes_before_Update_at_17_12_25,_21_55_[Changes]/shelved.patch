Index: src/main/java/ddb/deso/service/GestorContabilidad.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package ddb.deso.service;\n\nimport ddb.deso.negocio.contabilidad.*;\nimport ddb.deso.almacenamiento.DAO.*;\nimport ddb.deso.almacenamiento.DTO.*; \nimport ddb.deso.negocio.habitaciones.*;\nimport ddb.deso.negocio.TipoFactura;\nimport ddb.deso.negocio.TipoServicio;\nimport ddb.deso.negocio.alojamiento.Alojado;\nimport ddb.deso.negocio.alojamiento.DatosCheckIn;\nimport ddb.deso.negocio.alojamiento.DatosCheckOut;\nimport ddb.deso.service.excepciones.ResponsableMenorEdadExcepcion;\n\nimport ddb.deso.service.strategias.EstrategiaGuardadoFactura;\nimport ddb.deso.service.strategias.GuardarFacturaJSON;\nimport ddb.deso.service.strategias.GuardarFacturaPDF;\nimport org.springframework.stereotype.Service;\nimport org.springframework.beans.factory.annotation.Autowired;\n\nimport java.time.LocalDate;\nimport java.time.LocalDateTime;\nimport java.time.LocalTime;\nimport java.time.Period;\nimport java.time.temporal.ChronoUnit;\nimport java.util.*;\nimport java.util.function.Consumer;\n\n@Service\npublic class GestorContabilidad {\n\n    private EstadiaDAO estadiaDAO;\n    private FacturaDAO facturaDAO;\n    private ResponsablePagoDAO responsablePagoDAO;\n    private HabitacionDAO habitacionDAO;\n    private AlojadoDAO alojadoDAO;\n    Map<String, ? extends EstrategiaGuardadoFactura> estrategias = Map.of(\n        \"pdf\", new GuardarFacturaPDF(),\n        \"json\", new GuardarFacturaJSON()\n    );\n\n    @Autowired\n    public GestorContabilidad(EstadiaDAO estadiaDAO, FacturaDAO facturaDAO, ResponsablePagoDAO respDAO, HabitacionDAO habDAO,AlojadoDAO alojadoDAO) {\n        this.estadiaDAO = estadiaDAO;\n        this.facturaDAO = facturaDAO;\n        this.responsablePagoDAO = respDAO;\n        this.habitacionDAO = habDAO;\n        this.alojadoDAO= alojadoDAO;\n    }\n    \n    //saco horaSalida porque no es necesario para buscar la estadia ahora\n\n    public Estadia existeEstadia(Long nroHabitacion)throws Exception {\n        \n        Habitacion hab = habitacionDAO.buscarPorNumero(nroHabitacion); \n        if (hab == null) throw new Exception(\"Habitación no encontrada\");\n\n        Estadia estadiaActual = null;\n        List<Estadia> todas = estadiaDAO.listar();\n        LocalDate hoy = LocalDate.now(); \n\n        for (Estadia e : todas) {\n            if ((e.getHabitacion().getNroHab().equals(nroHabitacion)) && \n                (e.getDatosCheckOut()==null)&&\n                (!hoy.isBefore(e.getFecha_inicio())) &&\n                (!hoy.isAfter(e.getFecha_fin()))){\n                estadiaActual = e; \n                break; \n            }\n        }\n        if (estadiaActual == null) throw new Exception(\"No hay estadía activa para esta habitación\");\n       \n    \n        return estadiaActual;//se necesita la entidad para otra funcion, en otro lugar\n                                //convierte a dto\n    }\n\n\n    \n    public DetalleFacturaDTO calcularDetalleFacturacion(Long nroHabitacion, LocalTime horaSalida) throws Exception {\n        // Busca la estadía activa (filtros estrictos)\n        Estadia estadiaActual = existeEstadia(nroHabitacion);\n        \n        // Delega el cálculo matemático al nuevo método privado\n        return calcularMontos(estadiaActual, horaSalida);\n    }\n\n    // 2. NUEVO MÉTODO PRIVADO (Solo matemática, sin búsquedas)\n    private DetalleFacturaDTO calcularMontos(Estadia estadia, LocalTime horaSalida) {\n        Habitacion hab = estadia.getHabitacion();\n        LocalDate inicio = estadia.getFecha_inicio();\n        LocalDate fin = estadia.getFecha_fin();\n        \n        LocalDateTime fechaHoraCombinada = LocalDateTime.of(fin, horaSalida);\n        DatosCheckOut datosCheckOut = new DatosCheckOut();\n        datosCheckOut.setFecha_hora_out(fechaHoraCombinada);\n\n        long dias = ChronoUnit.DAYS.between(inicio, fin);\n\n        // Ajuste de días\n        if (dias == 0) dias = 1; \n\n        double precioNoche = hab.getTarifa(); \n        double costoEstadia = dias * precioNoche;\n\n        // Lógica de Late Check-Out\n        if (horaSalida.isAfter(LocalTime.of(11, 0)) && horaSalida.isBefore(LocalTime.of(18, 0))) {\n            costoEstadia += (precioNoche * 0.5); \n        } else if (horaSalida.isAfter(LocalTime.of(18, 0))) {\n            costoEstadia += precioNoche; \n        }\n\n        // Servicios\n        List<Servicio> serviciosEntity = estadia.getListaServicios();\n        List<ServicioDTO> serviciosDTO = new ArrayList<>();\n        double totalServicios = 0.0;\n\n        if (serviciosEntity != null) {\n            for (Servicio s : serviciosEntity) {\n                double precio = calcularPrecioServicio(s.getTipo_servicio());\n                ServicioDTO dto = new ServicioDTO();\n                dto.setIdServicio(s.getIdServicio());\n                dto.setTipoServicio(s.getTipo_servicio());\n                dto.setPrecio(precio); \n                serviciosDTO.add(dto);\n                totalServicios += precio;\n            }\n        }\n\n        TipoFactura tipoSugerido = TipoFactura.B;\n\n        return new DetalleFacturaDTO(\n            estadia.getIdEstadia(), \n            \"Habitación \" + hab.getNroHab() + \" - \" + hab.getTipo_hab(),\n            costoEstadia,\n            serviciosDTO,\n            costoEstadia + totalServicios,\n            tipoSugerido\n        );\n    }\n\n    // 3. MODIFICAR GENERAR FACTURA \n    public FacturaDTO generarFactura(GenerarFacturaRequestDTO request) throws Exception {\n        \n        Long idEstadia = request.getIdEstadia();\n        Long idResponsable = request.getIdResponsable();\n\n        validarEdadResponsable(idResponsable);\n\n        Estadia estadia = estadiaDAO.read(idEstadia); \n        ResponsablePago responsable = responsablePagoDAO.read(idResponsable);\n\n        if (estadia == null || responsable == null) throw new Exception(\"Datos inválidos\");\n\n       \n        Factura nuevaFactura = new Factura();\n        nuevaFactura.setFecha_factura(LocalDate.now()); \n        nuevaFactura.setDestinatario(responsable.getRazonSocial());\n        TipoFactura tipo = (responsable.getCuit() != null && responsable.getCuit() > 0) ? TipoFactura.A : TipoFactura.B;\n        nuevaFactura.setTipo_factura(tipo); \n\n        \n        LocalTime hora_checkout;\n        if (estadia.getDatosCheckOut() != null) {\n            hora_checkout = estadia.getDatosCheckOut().getFecha_hora_out().toLocalTime();\n        } else {\n            hora_checkout = LocalTime.now();\n        }\n        \n        DetalleFacturaDTO detalle = calcularMontos(estadia, hora_checkout);\n        // -------------------------\n\n        float total = detalle.getMontoTotal().floatValue();\n        nuevaFactura.setImporte_total(total);\n        \n        // ... (Cálculo de IVA y Guardado ) ...\n        if (tipo == TipoFactura.A) {\n            float neto = (float) (total / 1.21);\n            float iva = total - neto;\n            nuevaFactura.setImporte_neto(neto);\n            nuevaFactura.setImporte_iva(iva);\n        } else {\n            nuevaFactura.setImporte_neto(total);\n            nuevaFactura.setImporte_iva(0);\n        }\n\n        FacturaDTO facturaParaGuardar = new FacturaDTO(nuevaFactura);\n        facturaDAO.crearFactura(facturaParaGuardar);\n\n        return facturaParaGuardar; \n    }\n\n\nprivate void validarEdadResponsable(Long cuitResponsable) throws ResponsableMenorEdadExcepcion {\n        // Listar todos los alojados\n        List<Alojado> alojados = alojadoDAO.listarAlojados();\n        \n        Optional<Alojado> personaEncontrada = alojados.stream()\n                .filter(a -> {\n                    if (a.getDatos() == null || \n                        a.getDatos().getDatos_personales() == null || \n                        a.getDatos().getDatos_personales().getCUIT() == null) {\n                        return false;\n                    }\n                    \n                    try {\n                        // Convertimos el CUIT de String (Alojado) a Long (Responsable) para comparar\n                        String cuitStr = a.getDatos().getDatos_personales().getCUIT();\n                        return Long.parseLong(cuitStr) == cuitResponsable;\n                    } catch (NumberFormatException e) {\n                        return false; // Si el CUIT no es numérico, no coincide\n                    }\n                }) \n                .findFirst();\n\n        if (personaEncontrada.isPresent()) {\n            // Usamos el getter correcto para la fecha: getFechanac()\n            LocalDate fechaNacimiento = personaEncontrada.get()\n                                        .getDatos().getDatos_personales().getFechanac();\n            \n            if (fechaNacimiento != null) {\n                int edad = Period.between(fechaNacimiento, LocalDate.now()).getYears();\n                if (edad < 18) {\n                    throw new ResponsableMenorEdadExcepcion(\n                        \"El responsable es menor de edad (\" + edad + \"). Se requiere mayor de 18.\"\n                    );\n                }\n            }\n        }\n    }\n\n    private double calcularPrecioServicio(TipoServicio tipo) {\n        if (tipo == null) return 0.0;\n        switch (tipo) {\n            case LAVADOYPLANCHADO: return 1500.0;\n            case BAR: return 4500.0;\n            case SAUNA: return 8000.0;\n            default: return 0.0;\n        }\n    }\n    \n    // Métodos placeholder\n    public ResponsablePago buscarRespPago() { return null; }\n    public boolean ingresarPago() { return false; }\n    public Pago listarCheques() { return null; }\n    public List<DatosCheckIn> listarIngresos() { return new ArrayList<>(); }\n    public void generarNotaCredito() { }\n    public void gestionarListado() { }\n\n    public void guardarFacturaSegunStrategy(FacturaDTO factura, String strat) {\n\n        if(estrategias == null || estrategias.isEmpty()){\n            estrategias = Map.of(\n                    \"pdf\", new GuardarFacturaPDF(),\n                    \"json\", new GuardarFacturaJSON()\n            );\n        }\n\n        try {\n            estrategias.get(strat).guardarFactura(factura);\n        } catch (Exception e) {\n            System.out.println(e.getMessage());\n        }\n    }\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/ddb/deso/service/GestorContabilidad.java b/src/main/java/ddb/deso/service/GestorContabilidad.java
--- a/src/main/java/ddb/deso/service/GestorContabilidad.java	(revision 98e32783a1e921a1866d9c233de5f2e4539f9b2a)
+++ b/src/main/java/ddb/deso/service/GestorContabilidad.java	(date 1766018647822)
@@ -46,8 +46,6 @@
         this.habitacionDAO = habDAO;
         this.alojadoDAO= alojadoDAO;
     }
-    
-    //saco horaSalida porque no es necesario para buscar la estadia ahora
 
     public Estadia existeEstadia(Long nroHabitacion)throws Exception {
         
@@ -70,22 +68,17 @@
         if (estadiaActual == null) throw new Exception("No hay estadía activa para esta habitación");
        
     
-        return estadiaActual;//se necesita la entidad para otra funcion, en otro lugar
-                                //convierte a dto
+        return estadiaActual;
     }
 
 
     
     public DetalleFacturaDTO calcularDetalleFacturacion(Long nroHabitacion, LocalTime horaSalida) throws Exception {
-        // Busca la estadía activa (filtros estrictos)
         Estadia estadiaActual = existeEstadia(nroHabitacion);
-        
-        // Delega el cálculo matemático al nuevo método privado
-        return calcularMontos(estadiaActual, horaSalida);
+        return calcularMontos(estadiaActual, null, true, horaSalida);
     }
 
-    // 2. NUEVO MÉTODO PRIVADO (Solo matemática, sin búsquedas)
-    private DetalleFacturaDTO calcularMontos(Estadia estadia, LocalTime horaSalida) {
+    private DetalleFacturaDTO calcularMontos(Estadia estadia, List<Long> idsConsumosAIncluir,boolean cobrarAlojamiento, LocalTime horaSalida) {
         Habitacion hab = estadia.getHabitacion();
         LocalDate inicio = estadia.getFecha_inicio();
         LocalDate fin = estadia.getFecha_fin();
@@ -96,33 +89,40 @@
 
         long dias = ChronoUnit.DAYS.between(inicio, fin);
 
-        // Ajuste de días
-        if (dias == 0) dias = 1; 
+        if (dias == 0) dias = 1;
 
-        double precioNoche = hab.getTarifa(); 
-        double costoEstadia = dias * precioNoche;
+        double precioNoche = hab.getTarifa();
+        double costoEstadia = 0.0;
 
-        // Lógica de Late Check-Out
-        if (horaSalida.isAfter(LocalTime.of(11, 0)) && horaSalida.isBefore(LocalTime.of(18, 0))) {
-            costoEstadia += (precioNoche * 0.5); 
-        } else if (horaSalida.isAfter(LocalTime.of(18, 0))) {
-            costoEstadia += precioNoche; 
+        if (cobrarAlojamiento) {
+            costoEstadia = dias * precioNoche;
+
+            // late check out solo si cobrarAlojamiento true
+            if (horaSalida.isAfter(LocalTime.of(11, 0)) && horaSalida.isBefore(LocalTime.of(18, 0))) {
+                costoEstadia += (precioNoche * 0.5);
+            } else if (horaSalida.isAfter(LocalTime.of(18, 0))) {
+                costoEstadia += precioNoche;
+            }
         }
 
-        // Servicios
         List<Servicio> serviciosEntity = estadia.getListaServicios();
         List<ServicioDTO> serviciosDTO = new ArrayList<>();
         double totalServicios = 0.0;
 
         if (serviciosEntity != null) {
             for (Servicio s : serviciosEntity) {
-                double precio = calcularPrecioServicio(s.getTipo_servicio());
-                ServicioDTO dto = new ServicioDTO();
-                dto.setIdServicio(s.getIdServicio());
-                dto.setTipoServicio(s.getTipo_servicio());
-                dto.setPrecio(precio); 
-                serviciosDTO.add(dto);
-                totalServicios += precio;
+                if (idsConsumosAIncluir == null || idsConsumosAIncluir.contains(s.getIdServicio())) {
+
+                    double precio = calcularPrecioServicio(s.getTipo_servicio());
+
+                    ServicioDTO dto = new ServicioDTO();
+                    dto.setIdServicio(s.getIdServicio());
+                    dto.setTipoServicio(s.getTipo_servicio());
+                    dto.setPrecio(precio);
+
+                    serviciosDTO.add(dto);
+                    totalServicios += precio;
+                }
             }
         }
 
@@ -138,41 +138,66 @@
         );
     }
 
+    private ResponsablePago crearResponsableDesdeRequest(GenerarFacturaRequestDTO request) throws Exception {
+
+        ResponsablePago nuevo = new ResponsablePago();
+
+        nuevo.setCuit(Long.parseLong(request.getResponsableId()));
+        nuevo.setRazonSocial(request.getDestinatario());
+
+        return nuevo;
+    }
+
     // 3. MODIFICAR GENERAR FACTURA 
     public FacturaDTO generarFactura(GenerarFacturaRequestDTO request) throws Exception {
-        
+        // id estadia
         Long idEstadia = request.getIdEstadia();
-        Long idResponsable = request.getIdResponsable();
-
-        validarEdadResponsable(idResponsable);
+        // id responsable
+        long idResponsable;
+        try {
+            idResponsable = Long.parseLong(request.getResponsableId());
+        } catch (NumberFormatException e) {
+            throw new Exception("ID de responsable inválido");
+        }
 
-        Estadia estadia = estadiaDAO.read(idEstadia); 
+        Estadia estadia = estadiaDAO.read(idEstadia);
         ResponsablePago responsable = responsablePagoDAO.read(idResponsable);
 
-        if (estadia == null || responsable == null) throw new Exception("Datos inválidos");
+        if (estadia == null) {
+            throw new Exception("Estadía inválida");
+        }
 
-       
+        if (responsable == null) {
+            responsable = crearResponsableDesdeRequest(request);
+        }
+
         Factura nuevaFactura = new Factura();
-        nuevaFactura.setFecha_factura(LocalDate.now()); 
+        nuevaFactura.setFecha_factura(LocalDate.now());
         nuevaFactura.setDestinatario(responsable.getRazonSocial());
-        TipoFactura tipo = (responsable.getCuit() != null && responsable.getCuit() > 0) ? TipoFactura.A : TipoFactura.B;
-        nuevaFactura.setTipo_factura(tipo); 
+
+        TipoFactura tipo = (request.getTipoFactura() != null) ?
+                TipoFactura.valueOf(String.valueOf(request.getTipoFactura())) :
+                TipoFactura.B;
+
+        nuevaFactura.setTipo_factura(tipo);
 
-        
         LocalTime hora_checkout;
         if (estadia.getDatosCheckOut() != null) {
             hora_checkout = estadia.getDatosCheckOut().getFecha_hora_out().toLocalTime();
         } else {
             hora_checkout = LocalTime.now();
         }
-        
-        DetalleFacturaDTO detalle = calcularMontos(estadia, hora_checkout);
-        // -------------------------
+
+        DetalleFacturaDTO detalle = calcularMontos(
+                estadia,
+                request.getIdsConsumosAIncluir(),
+                request.isCobrarAlojamiento(),
+                hora_checkout
+        );
 
         float total = detalle.getMontoTotal().floatValue();
         nuevaFactura.setImporte_total(total);
-        
-        // ... (Cálculo de IVA y Guardado ) ...
+
         if (tipo == TipoFactura.A) {
             float neto = (float) (total / 1.21);
             float iva = total - neto;
@@ -186,7 +211,7 @@
         FacturaDTO facturaParaGuardar = new FacturaDTO(nuevaFactura);
         facturaDAO.crearFactura(facturaParaGuardar);
 
-        return facturaParaGuardar; 
+        return facturaParaGuardar;
     }
 
 
@@ -246,19 +271,7 @@
     public void generarNotaCredito() { }
     public void gestionarListado() { }
 
-    public void guardarFacturaSegunStrategy(FacturaDTO factura, String strat) {
-
-        if(estrategias == null || estrategias.isEmpty()){
-            estrategias = Map.of(
-                    "pdf", new GuardarFacturaPDF(),
-                    "json", new GuardarFacturaJSON()
-            );
-        }
-
-        try {
-            estrategias.get(strat).guardarFactura(factura);
-        } catch (Exception e) {
-            System.out.println(e.getMessage());
-        }
+    public byte[] guardarFacturaSegunStrategy(FacturaDTO factura, String strat) {
+        return estrategias.get(strat).guardarFactura(factura);
     }
 }
\ No newline at end of file
Index: src/main/java/ddb/deso/controller/FacturaController.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package ddb.deso.controller;\n\nimport org.hibernate.type.OrderedMapType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.web.bind.annotation.*;\nimport ddb.deso.service.GestorContabilidad; \nimport ddb.deso.almacenamiento.DTO.*;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.format.annotation.DateTimeFormat;\nimport ddb.deso.negocio.habitaciones.Estadia;\n\nimport java.time.LocalTime;\nimport java.util.Map;\nimport java.util.TreeMap;\nimport java.util.function.Consumer;\nimport java.util.function.Function;\n\n@RestController\n@RequestMapping(\"/api/facturacion\")\npublic class FacturaController {\n\n    @Autowired\n    private GestorContabilidad gestorContabilidad;\n\n    @GetMapping(\"/habitacion/{nroHabitacion}/verificar-estadia\")\n    public ResponseEntity<EstadiaDTO> verificarEstadiaActiva(\n            @PathVariable Long nroHabitacion,\n            @RequestParam(required = false) @DateTimeFormat(iso = DateTimeFormat.ISO.TIME) LocalTime horaSalida) {\n        \n        try {\n\n            if (horaSalida == null) {\n                horaSalida = LocalTime.now();\n            }\n\n            Estadia estadia = gestorContabilidad.existeEstadia(nroHabitacion);\n            EstadiaDTO estadiaDTO= new EstadiaDTO(estadia);\n            return ResponseEntity.ok(estadiaDTO);\n\n        } catch (Exception e) {\n    \n            return ResponseEntity.notFound().build();\n        }\n    }\n    // Paso 1: Pre-visualización (No se usa generalmente pero lo dejo por las dudas)\n    @GetMapping(\"/habitacion/{nroHabitacion}/detalle\")\n    public ResponseEntity<DetalleFacturaDTO> obtenerDetalleFacturacion(\n            @PathVariable Long nroHabitacion,\n            @RequestParam @DateTimeFormat(iso = DateTimeFormat.ISO.TIME) LocalTime horaSalida) {\n        \n        try {\n            // Llama al método del gestor para obtener los cálculos previos\n            DetalleFacturaDTO detalle = gestorContabilidad.calcularDetalleFacturacion(nroHabitacion, horaSalida);\n            return ResponseEntity.ok(detalle);\n        } catch (Exception e) {\n            e.printStackTrace();\n            return ResponseEntity.badRequest().body(null); \n        }\n    }\n\n    // Paso 2: Generar la factura\n    @PostMapping(\"/generar\")\n    public ResponseEntity<FacturaDTO> generarFactura(@RequestBody GenerarFacturaRequestDTO request) {\n        try {\n            FacturaDTO factura = gestorContabilidad.generarFactura(request);\n            return ResponseEntity.ok(factura);\n        } catch (Exception e) {\n            e.printStackTrace(); // Imprime el error en la consola del servidor\n            return ResponseEntity.badRequest().build();\n        }\n    }\n\n    @PostMapping(\"api/imprimir-factura\")\n    public ResponseEntity<FacturaDTO> imprimirFactura(@RequestBody FacturaDTO factura, @RequestParam String strat){\n\n        if(factura == null || strat == null || strat.isEmpty()){\n            return ResponseEntity.badRequest().build();\n        }\n\n        gestorContabilidad.guardarFacturaSegunStrategy(factura, strat);\n\n        return ResponseEntity.ok(factura);\n    }\n\n  \n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/ddb/deso/controller/FacturaController.java b/src/main/java/ddb/deso/controller/FacturaController.java
--- a/src/main/java/ddb/deso/controller/FacturaController.java	(revision 98e32783a1e921a1866d9c233de5f2e4539f9b2a)
+++ b/src/main/java/ddb/deso/controller/FacturaController.java	(date 1766015952650)
@@ -62,6 +62,7 @@
     @PostMapping("/generar")
     public ResponseEntity<FacturaDTO> generarFactura(@RequestBody GenerarFacturaRequestDTO request) {
         try {
+            System.out.println("IDS CONSUMOS: " + request.getIdsConsumosAIncluir());
             FacturaDTO factura = gestorContabilidad.generarFactura(request);
             return ResponseEntity.ok(factura);
         } catch (Exception e) {
@@ -69,17 +70,18 @@
             return ResponseEntity.badRequest().build();
         }
     }
-
-    @PostMapping("api/imprimir-factura")
-    public ResponseEntity<FacturaDTO> imprimirFactura(@RequestBody FacturaDTO factura, @RequestParam String strat){
-
-        if(factura == null || strat == null || strat.isEmpty()){
-            return ResponseEntity.badRequest().build();
-        }
 
-        gestorContabilidad.guardarFacturaSegunStrategy(factura, strat);
+    @PostMapping("/imprimir-factura")
+    public ResponseEntity<byte[]> imprimirFactura(
+            @RequestBody FacturaDTO factura,
+            @RequestParam String strat
+    ) {
+        byte[] pdf = gestorContabilidad.guardarFacturaSegunStrategy(factura, strat);
 
-        return ResponseEntity.ok(factura);
+        return ResponseEntity.ok()
+                .header("Content-Disposition", "attachment; filename=factura.pdf")
+                .header("Content-Type", "application/pdf")
+                .body(pdf);
     }
 
   
Index: src/main/java/ddb/deso/almacenamiento/DTO/GenerarFacturaRequestDTO.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package ddb.deso.almacenamiento.DTO;\n\nimport java.util.List;\n\npublic class GenerarFacturaRequestDTO {\n\n    private Long idEstadia;\n    private Long idResponsable;\n    // Lista de IDs de servicios específicos a facturar (opcional, si null se factura todo)\n    private List<Long> idsServicios; \n\n    public GenerarFacturaRequestDTO() {\n    }\n\n    public GenerarFacturaRequestDTO(Long idEstadia, Long idResponsable, List<Long> idsServicios) {\n        this.idEstadia = idEstadia;\n        this.idResponsable = idResponsable;\n        this.idsServicios = idsServicios;\n    }\n\n    public Long getIdEstadia() {\n        return idEstadia;\n    }\n\n    public void setIdEstadia(Long idEstadia) {\n        this.idEstadia = idEstadia;\n    }\n\n    public Long getIdResponsable() {\n        return idResponsable;\n    }\n\n    public void setIdResponsable(Long idResponsable) {\n        this.idResponsable = idResponsable;\n    }\n\n    public List<Long> getIdsServicios() {\n        return idsServicios;\n    }\n\n    public void setIdsServicios(List<Long> idsServicios) {\n        this.idsServicios = idsServicios;\n    }\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/ddb/deso/almacenamiento/DTO/GenerarFacturaRequestDTO.java b/src/main/java/ddb/deso/almacenamiento/DTO/GenerarFacturaRequestDTO.java
--- a/src/main/java/ddb/deso/almacenamiento/DTO/GenerarFacturaRequestDTO.java	(revision 98e32783a1e921a1866d9c233de5f2e4539f9b2a)
+++ b/src/main/java/ddb/deso/almacenamiento/DTO/GenerarFacturaRequestDTO.java	(date 1766015570494)
@@ -1,44 +1,25 @@
 package ddb.deso.almacenamiento.DTO;
 
+import ddb.deso.negocio.TipoFactura;
+import lombok.Getter;
+import lombok.Setter;
+import lombok.NoArgsConstructor;
+import lombok.AllArgsConstructor;
 import java.util.List;
 
+@Getter
+@Setter
+@NoArgsConstructor
+@AllArgsConstructor
 public class GenerarFacturaRequestDTO {
 
     private Long idEstadia;
-    private Long idResponsable;
-    // Lista de IDs de servicios específicos a facturar (opcional, si null se factura todo)
-    private List<Long> idsServicios; 
-
-    public GenerarFacturaRequestDTO() {
-    }
-
-    public GenerarFacturaRequestDTO(Long idEstadia, Long idResponsable, List<Long> idsServicios) {
-        this.idEstadia = idEstadia;
-        this.idResponsable = idResponsable;
-        this.idsServicios = idsServicios;
-    }
-
-    public Long getIdEstadia() {
-        return idEstadia;
-    }
-
-    public void setIdEstadia(Long idEstadia) {
-        this.idEstadia = idEstadia;
-    }
+    private TipoFactura tipoFactura;
+    private String destinatario;
+    private boolean cobrarAlojamiento;
 
-    public Long getIdResponsable() {
-        return idResponsable;
-    }
+    private List<Long> idsConsumosAIncluir;
 
-    public void setIdResponsable(Long idResponsable) {
-        this.idResponsable = idResponsable;
-    }
-
-    public List<Long> getIdsServicios() {
-        return idsServicios;
-    }
-
-    public void setIdsServicios(List<Long> idsServicios) {
-        this.idsServicios = idsServicios;
-    }
+    private String responsableId;
+    private String responsableTipo;
 }
\ No newline at end of file
Index: src/main/java/ddb/deso/negocio/contabilidad/PersonaJuridica.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/ddb/deso/negocio/contabilidad/PersonaJuridica.java b/src/main/java/ddb/deso/negocio/contabilidad/PersonaJuridica.java
new file mode 100644
--- /dev/null	(date 1766011851793)
+++ b/src/main/java/ddb/deso/negocio/contabilidad/PersonaJuridica.java	(date 1766011851793)
@@ -0,0 +1,20 @@
+package ddb.deso.almacenamiento.DTO;
+
+import ddb.deso.negocio.alojamiento.Alojado;
+import ddb.deso.negocio.alojamiento.Huesped;
+import lombok.Getter;
+import lombok.NoArgsConstructor;
+import lombok.Setter;
+
+@NoArgsConstructor
+@Getter
+@Setter
+public class PersonaJuridica {
+    private String razonSoc;
+    private String cuit;
+
+    public PersonaJuridica(Huesped a){
+        this.razonSoc = (a.getRazon_social() == null ? "" : a.getRazon_social());
+        this.cuit = a.getDatos().getDatos_personales().getCUIT();
+    }
+}
Index: src/main/java/ddb/deso/service/strategias/GuardarFacturaPDF.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package ddb.deso.service.strategias;\n\nimport ddb.deso.almacenamiento.DTO.FacturaDTO;\nimport lombok.NoArgsConstructor;\n\nimport com.lowagie.text.Document;\nimport com.lowagie.text.DocumentException;\nimport com.lowagie.text.Paragraph;\nimport com.lowagie.text.pdf.PdfWriter;\n\nimport java.io.FileNotFoundException;\nimport java.io.FileOutputStream;\nimport java.io.IOException;\nimport java.nio.file.Files;\nimport java.nio.file.Paths;\n\n@NoArgsConstructor\npublic class GuardarFacturaPDF implements EstrategiaGuardadoFactura {\n\n    /**\n     * @param factura\n     */\n    @Override\n    public void guardarFactura(FacturaDTO factura) {\n\n        Document document = new Document();\n\n        try {\n            Files.createDirectories(Paths.get(\"data/factura\"));\n            String nombreArchivo = \"data/factura/factura_\" + factura.getNum_factura() + \".pdf\";\n            PdfWriter.getInstance(document, new FileOutputStream(nombreArchivo));\n\n            document.open();\n            document.add(new Paragraph(\"FACTURA - HOTEL DESO\"));\n            document.add(new Paragraph(\"------------------------------------------------\"));\n\n            document.add(new Paragraph(\"Fecha: \" + factura.getFecha_factura()));\n            document.add(new Paragraph(\"Número de Factura: \" + factura.getNum_factura()));\n            document.add(new Paragraph(\"Tipo: \" + factura.getTipo_factura()));\n            document.add(new Paragraph(\"Cliente (Destinatario): \" + factura.getDestinatario()));\n\n            document.add(new Paragraph(\"------------------------------------------------\"));\n\n            document.add(new Paragraph(\"Importe Neto: $\" + factura.getImporte_neto()));\n            document.add(new Paragraph(\"Importe IVA: $\" + factura.getImporte_iva()));\n            document.add(new Paragraph(\"IMPORTE TOTAL: $\" + factura.getImporte_total()));\n\n            System.out.println(\"PDF generado exitosamente: \" + nombreArchivo);\n\n        } catch (DocumentException | FileNotFoundException e) {\n            e.printStackTrace();\n            System.err.println(\"Error al generar el PDF: \" + e.getMessage());\n        } catch (IOException e) {\n            throw new RuntimeException(e);\n        } finally {\n            if (document.isOpen()) {\n                document.close();\n            }\n        }\n    }\n}\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/ddb/deso/service/strategias/GuardarFacturaPDF.java b/src/main/java/ddb/deso/service/strategias/GuardarFacturaPDF.java
--- a/src/main/java/ddb/deso/service/strategias/GuardarFacturaPDF.java	(revision 98e32783a1e921a1866d9c233de5f2e4539f9b2a)
+++ b/src/main/java/ddb/deso/service/strategias/GuardarFacturaPDF.java	(date 1766013932222)
@@ -9,11 +9,9 @@
 import com.lowagie.text.pdf.PdfWriter;
 
 import java.io.FileNotFoundException;
-import java.io.FileOutputStream;
+import java.io.ByteArrayOutputStream;
+
 import java.io.IOException;
-import java.nio.file.Files;
-import java.nio.file.Paths;
-
 @NoArgsConstructor
 public class GuardarFacturaPDF implements EstrategiaGuardadoFactura {
 
@@ -21,41 +19,35 @@
      * @param factura
      */
     @Override
-    public void guardarFactura(FacturaDTO factura) {
-
-        Document document = new Document();
+    public byte[] guardarFactura(FacturaDTO factura) {
 
         try {
-            Files.createDirectories(Paths.get("data/factura"));
-            String nombreArchivo = "data/factura/factura_" + factura.getNum_factura() + ".pdf";
-            PdfWriter.getInstance(document, new FileOutputStream(nombreArchivo));
+            ByteArrayOutputStream out = new ByteArrayOutputStream();
+            Document document = new Document();
+            PdfWriter.getInstance(document, out);
+
 
             document.open();
-            document.add(new Paragraph("FACTURA - HOTEL DESO"));
+            document.add(new Paragraph("FACTURA - HOTEL PREMIER"));
+            document.add(new Paragraph("Lavaisse 610 - S3004EWB Santa Fe"));
             document.add(new Paragraph("------------------------------------------------"));
 
             document.add(new Paragraph("Fecha: " + factura.getFecha_factura()));
-            document.add(new Paragraph("Número de Factura: " + factura.getNum_factura()));
+            document.add(new Paragraph("Número de factura: " + factura.getNum_factura()));
             document.add(new Paragraph("Tipo: " + factura.getTipo_factura()));
-            document.add(new Paragraph("Cliente (Destinatario): " + factura.getDestinatario()));
+            document.add(new Paragraph("Cliente: " + factura.getDestinatario()));
 
             document.add(new Paragraph("------------------------------------------------"));
 
             document.add(new Paragraph("Importe Neto: $" + factura.getImporte_neto()));
             document.add(new Paragraph("Importe IVA: $" + factura.getImporte_iva()));
             document.add(new Paragraph("IMPORTE TOTAL: $" + factura.getImporte_total()));
-
-            System.out.println("PDF generado exitosamente: " + nombreArchivo);
-
-        } catch (DocumentException | FileNotFoundException e) {
-            e.printStackTrace();
-            System.err.println("Error al generar el PDF: " + e.getMessage());
-        } catch (IOException e) {
-            throw new RuntimeException(e);
-        } finally {
-            if (document.isOpen()) {
-                document.close();
-            }
+            document.close();
+            System.out.println("Factura creada con éxito");
+            return out.toByteArray();
+
+        } catch (Exception e) {
+            throw new RuntimeException("Error generando PDF", e);
         }
     }
 }
Index: hotel-premier/src/services/facturar.service.ts
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import {\n  DetalleFacturaDTO,\n  GenerarFacturaRequestDTO,\n} from \"@/types/facturacion\";\n\nimport {\n  CriteriosBusq,\n  PersonaJuridica,\n  EstadiaDTO,\n  AlojadoDTO,\n} from \"@/types/facturacion\";\n\nconst PUERTO = \"http://localhost:8080/api\";\n\n// ESTADIA EXISTE?\nexport async function verificarEstadia(\n  id_hab: string,\n  hora_checkout: string\n): Promise<EstadiaDTO | null> {\n  if (!id_hab) return null;\n\n  const params = new URLSearchParams({\n    horaSalida: hora_checkout || \"\",\n  });\n  console.log(\"Verificando en back que exista la estadía...\");\n\n  try {\n    const response = await fetch(\n      `${PUERTO}/facturacion/habitacion/${id_hab}/verificar-estadia?${params.toString()}`,\n      {\n        method: \"GET\",\n        headers: { \"Content-Type\": \"application/json\" },\n        cache: \"no-store\",\n      }\n    );\n    if (response.status === 404) {\n      console.log(\"Estadía no encontrada\");\n      return null;\n    }\n\n    if (!response.ok) {\n      throw new Error(\"Error del servidor: \" + response.status);\n    }\n\n    // CORRECCIÓN: Leemos una sola vez\n    const data = await response.json();\n    console.log(\"Se encontró la estadía:\", data);\n\n    return data;\n  } catch (error) {\n    console.error(\"Error buscando estadía: \" + error);\n    return null;\n  }\n}\n\n// OCUPANTES ESTADÍA\nexport async function buscarAlojados(\n  id_estadia: string\n): Promise<CriteriosBusq[]> {\n  const params = new URLSearchParams({\n    idEstadia: id_estadia.toString(),\n  });\n  console.log(\"Pidiendo ocupantes en el back...\");\n  try {\n    const response = await fetch(\n      `${PUERTO}/buscar-huespedes-de-estadia?${params.toString()}`,\n      {\n        method: \"GET\",\n        headers: { \"Content-Type\": \"application/json\" },\n        cache: \"no-store\",\n      }\n    );\n\n    if (!response.ok) {\n      console.log(\"Ocupantes vacío o error\");\n      return [];\n    }\n\n    const data = await response.json();\n    console.log(\"OCUPANTES:\", data);\n\n    return data;\n  } catch (error) {\n    console.error(\"Error buscando alojados: \" + error);\n    return [];\n  }\n}\n\n// DETALLE HUESPED COMPLETO\nexport async function obtenerDatosHuesped(\n  nroDoc: string,\n  tipoDoc: string\n): Promise<AlojadoDTO> {\n  const params = new URLSearchParams({\n    nroDoc: nroDoc,\n    tipoDocStr: tipoDoc,\n  });\n\n  try {\n    const response = await fetch(\n      `${PUERTO}/obtener-atributos-huesped?${params.toString()}`,\n      {\n        method: \"GET\",\n        headers: { \"Content-Type\": \"application/json\" },\n        cache: \"no-store\",\n      }\n    );\n\n    if (!response.ok) throw new Error(\"Error obteniendo datos del huésped\");\n    return await response.json();\n  } catch (error) {\n    console.error(error);\n    throw error;\n  }\n}\n\n// QUE PAGUE PERSONA JURIDICA\nexport async function buscarTercero(cuit: string): Promise<PersonaJuridica> {\n  const params = new URLSearchParams({ cuit: cuit });\n  console.log(\"Pidiendo razón social al back para CUIT:\", cuit);\n  try {\n    const response = await fetch(\n      `${PUERTO}/buscar-tercero?${params.toString()}`,\n      {\n        method: \"GET\",\n        headers: { \"Content-Type\": \"application/json\" },\n        cache: \"no-store\",\n      }\n    );\n\n    if (!response.ok) throw new Error(\"No se encontró la empresa\");\n\n    return await response.json();\n  } catch (er) {\n    throw er;\n  }\n}\n\n// ITEMS FACTURA GRILLA\nexport async function obtenerDetalleFacturacion(\n  nroHab: string,\n  horaSalida: string\n): Promise<DetalleFacturaDTO> {\n  const params = new URLSearchParams({\n    horaSalida: horaSalida,\n  });\n\n  try {\n    const response = await fetch(\n      `${PUERTO}/facturacion/habitacion/${nroHab}/detalle?${params.toString()}`,\n      {\n        method: \"GET\",\n        headers: { \"Content-Type\": \"application/json\" },\n        cache: \"no-store\",\n      }\n    );\n\n    if (!response.ok) throw new Error(\"Error obteniendo el detalle\");\n    return await response.json();\n  } catch (error) {\n    console.error(error);\n    throw error;\n  }\n}\n\n// PEDIR FACTURA\nexport async function generarFacturaFinal(request: GenerarFacturaRequestDTO) {\n  try {\n    const response = await fetch(`${PUERTO}/facturacion/generar`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(request),\n    });\n\n    if (!response.ok) throw new Error(\"Error generando factura\");\n    return await response.json();\n  } catch (error) {\n    throw error;\n  }\n}\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/hotel-premier/src/services/facturar.service.ts b/hotel-premier/src/services/facturar.service.ts
--- a/hotel-premier/src/services/facturar.service.ts	(revision 98e32783a1e921a1866d9c233de5f2e4539f9b2a)
+++ b/hotel-premier/src/services/facturar.service.ts	(date 1766013385058)
@@ -8,6 +8,7 @@
   PersonaJuridica,
   EstadiaDTO,
   AlojadoDTO,
+  FacturaDTO,
 } from "@/types/facturacion";
 
 const PUERTO = "http://localhost:8080/api";
@@ -178,3 +179,21 @@
     throw error;
   }
 }
+
+export async function descargarFacturaPDF(factura: FacturaDTO) {
+  const response = await fetch(
+    "http://localhost:8080/api/facturacion/imprimir-factura?strat=pdf",
+    {
+      method: "POST",
+      headers: { "Content-Type": "application/json" },
+      body: JSON.stringify(factura),
+    }
+  );
+
+  if (!response.ok) {
+    throw new Error("Error descargando factura");
+  }
+
+  const blob = await response.blob();
+  return blob;
+}
Index: src/main/java/ddb/deso/service/strategias/EstrategiaGuardadoFactura.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package ddb.deso.service.strategias;\n\nimport ddb.deso.almacenamiento.DTO.FacturaDTO;\n\npublic interface EstrategiaGuardadoFactura {\n\n    public void guardarFactura(FacturaDTO factura);\n\n}\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/ddb/deso/service/strategias/EstrategiaGuardadoFactura.java b/src/main/java/ddb/deso/service/strategias/EstrategiaGuardadoFactura.java
--- a/src/main/java/ddb/deso/service/strategias/EstrategiaGuardadoFactura.java	(revision 98e32783a1e921a1866d9c233de5f2e4539f9b2a)
+++ b/src/main/java/ddb/deso/service/strategias/EstrategiaGuardadoFactura.java	(date 1766012887298)
@@ -4,6 +4,6 @@
 
 public interface EstrategiaGuardadoFactura {
 
-    public void guardarFactura(FacturaDTO factura);
+    byte[] guardarFactura(FacturaDTO factura);
 
 }
Index: src/main/java/ddb/deso/service/strategias/GuardarFacturaJSON.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package ddb.deso.service.strategias;\n\nimport com.fasterxml.jackson.databind.ObjectMapper;\nimport com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;\nimport ddb.deso.almacenamiento.DTO.FacturaDTO;\nimport lombok.NoArgsConstructor;\n\nimport java.io.File;\nimport java.io.IOException;\nimport java.nio.file.Files;\nimport java.nio.file.Paths;\nimport java.util.EmptyStackException;\n\n@NoArgsConstructor\npublic class GuardarFacturaJSON implements EstrategiaGuardadoFactura {\n    /**\n     * @param factura\n     */\n    @Override\n    public void guardarFactura(FacturaDTO factura) {\n        try {\n            ObjectMapper mapper = new ObjectMapper();\n\n            mapper.registerModule(new JavaTimeModule());\n\n            Files.createDirectories(Paths.get(\"data/factura\"));\n            String nombreArchivo = \"data/factura/factura_\" + factura.getNum_factura() + \".json\";\n\n            mapper.writerWithDefaultPrettyPrinter().writeValue(new File(nombreArchivo), factura);\n\n            System.out.println(\"Factura guardada exitosamente en JSON: \" + nombreArchivo);\n\n        } catch (IOException e) {\n            System.err.println(\"Error al guardar la factura JSON: \" + e.getMessage());\n            e.printStackTrace();\n        }\n    }\n}\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/ddb/deso/service/strategias/GuardarFacturaJSON.java b/src/main/java/ddb/deso/service/strategias/GuardarFacturaJSON.java
--- a/src/main/java/ddb/deso/service/strategias/GuardarFacturaJSON.java	(revision 98e32783a1e921a1866d9c233de5f2e4539f9b2a)
+++ b/src/main/java/ddb/deso/service/strategias/GuardarFacturaJSON.java	(date 1766013833434)
@@ -1,6 +1,7 @@
 package ddb.deso.service.strategias;
 
 import com.fasterxml.jackson.databind.ObjectMapper;
+import java.nio.charset.StandardCharsets;
 import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
 import ddb.deso.almacenamiento.DTO.FacturaDTO;
 import lombok.NoArgsConstructor;
@@ -9,30 +10,19 @@
 import java.io.IOException;
 import java.nio.file.Files;
 import java.nio.file.Paths;
-import java.util.EmptyStackException;
 
 @NoArgsConstructor
 public class GuardarFacturaJSON implements EstrategiaGuardadoFactura {
-    /**
-     * @param factura
-     */
+
+    private final ObjectMapper mapper = new ObjectMapper();
+
     @Override
-    public void guardarFactura(FacturaDTO factura) {
+    public byte[] guardarFactura(FacturaDTO factura) {
         try {
-            ObjectMapper mapper = new ObjectMapper();
-
-            mapper.registerModule(new JavaTimeModule());
-
-            Files.createDirectories(Paths.get("data/factura"));
-            String nombreArchivo = "data/factura/factura_" + factura.getNum_factura() + ".json";
-
-            mapper.writerWithDefaultPrettyPrinter().writeValue(new File(nombreArchivo), factura);
-
-            System.out.println("Factura guardada exitosamente en JSON: " + nombreArchivo);
-
-        } catch (IOException e) {
-            System.err.println("Error al guardar la factura JSON: " + e.getMessage());
-            e.printStackTrace();
+            String json = mapper.writeValueAsString(factura);
+            return json.getBytes(StandardCharsets.UTF_8);
+        } catch (Exception e) {
+            throw new RuntimeException("Error generando JSON", e);
         }
     }
 }
Index: hotel-premier/src/app/(app)/facturar/page.tsx
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>\"use client\";\nimport { useState, useEffect } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { CriteriosBusq, AlojadoDTO } from \"@/types/facturacion\";\nimport {\n  buscarAlojados,\n  obtenerDetalleFacturacion,\n  generarFacturaFinal,\n  verificarEstadia,\n  obtenerDatosHuesped,\n} from \"@/services/facturar.service\";\nimport { DetalleFacturaDTO } from \"@/types/facturacion\";\nimport GrillaAlojados, { ResponsablePago } from \"@/components/grilla_alojados\";\nimport { pedirHabs, Habitacion } from \"../../../services/habitaciones.service\";\nimport GrillaItemsFactura from \"@/components/grilla_factura\";\n\n// revisar de donde sacar que es mayor\nconst esMayorDeEdad = (fechaNacStr: string): boolean => {\n  if (!fechaNacStr) return false;\n  const nacimiento = new Date(fechaNacStr);\n  const hoy = new Date();\n  let edad = hoy.getFullYear() - nacimiento.getFullYear();\n  const m = hoy.getMonth() - nacimiento.getMonth();\n  if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) {\n    edad--;\n  }\n  return edad >= 18;\n};\n\nexport default function Facturar() {\n  const router = useRouter();\n  const [error, setError] = useState<string | null>(null);\n  const [id_hab, setIdHab] = useState(\"\");\n  const [id_est, setIdEst] = useState(\"\");\n  const [hora_checkout, setHora] = useState(\"\");\n\n  const [listaHabitaciones, setListaHabitaciones] = useState<Habitacion[]>([]);\n  const [listaAlojados, setListaAlojados] = useState<CriteriosBusq[]>([]);\n  const [responsableSeleccionado, setResponsableSeleccionado] =\n    useState<ResponsablePago | null>(null);\n  const [detalleFactura, setDetalleFactura] =\n    useState<DetalleFacturaDTO | null>(null);\n\n  let estadia_existe = false;\n\n  const [paso, setPaso] = useState<\n    | \"BUSCAR\"\n    | \"GRILLA\"\n    | \"CARGANDO_CONSUMOS\"\n    | \"COBRANDO\"\n    | \"GUARDANDO\"\n    | \"EXITO\"\n  >(\"BUSCAR\");\n\n  useEffect(() => {\n    const cargarHabitaciones = async () => {\n      try {\n        const data = await pedirHabs();\n        setListaHabitaciones(data.sort((a, b) => a.nroHab - b.nroHab));\n      } catch (err) {\n        console.error(\"Error cargando habitaciones:\", err);\n        setError(\"No se pudieron cargar las habitaciones.\");\n      }\n    };\n    cargarHabitaciones();\n  }, []);\n\n  const checkOut = async () => {\n    setError(null);\n    if (!id_hab || !hora_checkout) {\n      setError(\"Debe completar el número de habitación y la hora de salida.\");\n      return;\n    }\n\n    console.log(\"Buscando habitaciones existentes\");\n\n    const nroHabInput = Number(id_hab);\n    // llamada a back para saber quiénes ocupan la hab. resp es una lista de CriteriosBusq\n    const habitacionEncontrada = listaHabitaciones.find(\n      (h) => h.nroHab === nroHabInput\n    );\n\n    if (!habitacionEncontrada) {\n      setError(\"El número de habitación es incorrecto o no existe.\");\n      return;\n    }\n\n    if (listaHabitaciones.length == 0) {\n      return;\n    }\n\n    // LLAMADA A BACK: verificar estadia. devuelve ESTADIA DTO\n    console.log(\"Verificando que exista la estadía\");\n    try {\n      const response = await verificarEstadia(id_hab, hora_checkout);\n      if (!response) {\n        setError(\"La habitación no está ocupada actualmente.\");\n        return;\n      }\n\n      if (!response) {\n        estadia_existe = false;\n      } else {\n        estadia_existe = true;\n        console.log(`Response ${response}`);\n\n        setIdEst(response.idEstadia.toString());\n      }\n    } catch (err) {\n      console.error(err);\n      setError(\"Error al traer los alojados.\");\n    }\n\n    if (estadia_existe) {\n      try {\n        // LLAMADA A BACK: obtengo los alojados de una estadía\n        const resp = await buscarAlojados(id_est);\n        // if id hab existe pero lista retorna vacía, entonces no esta ocupada throw error hab no ocupada\n\n        if (!resp || resp.length === 0) {\n          setError(\"La habitación no está ocupada actualmente.\");\n          return;\n        }\n        console.log(`Alojados: ${resp}`);\n\n        setListaAlojados(resp);\n        setPaso(\"GRILLA\");\n      } catch (e) {\n        console.error(e);\n        setError(\"Error al traer los alojados.\");\n      }\n    }\n  };\n\n  const cargarConsumos = async () => {\n    setPaso(\"CARGANDO_CONSUMOS\");\n    try {\n      const detalle = await obtenerDetalleFacturacion(id_hab, hora_checkout);\n      setDetalleFactura(detalle);\n      setPaso(\"COBRANDO\");\n    } catch (err) {\n      console.error(err);\n      setError(\n        \"Error al obtener los consumos de la habitación. Intente nuevamente.\"\n      );\n      setPaso(\"GRILLA\");\n    }\n  };\n\n  const handleSeleccionResponsable = (alojado: ResponsablePago) => {\n    console.log(\"Responsable seleccionado:\", alojado);\n    setResponsableSeleccionado(alojado);\n    setError(null);\n  };\n\n  const avanzarAFacturacion = async () => {\n    if (!responsableSeleccionado) {\n      setError(\"Debe seleccionar un responsable.\");\n      return;\n    }\n\n    if (\"razonSoc\" in responsableSeleccionado) {\n      setPaso(\"CARGANDO_CONSUMOS\");\n      cargarConsumos();\n      return;\n    }\n\n    try {\n      const huespedCompleto = await obtenerDatosHuesped(\n        responsableSeleccionado.nroDoc,\n        responsableSeleccionado.tipoDoc || \"DNI\"\n      );\n\n      if (!esMayorDeEdad(huespedCompleto.fechanac)) {\n        setError(\n          `El huésped ${responsableSeleccionado.nombre} es menor de edad. Seleccione un adulto o facture a tercero.`\n        );\n        return;\n      }\n\n      cargarConsumos();\n    } catch (err) {\n      console.error(err);\n      setError(\"Error al verificar los datos del huésped. Intente nuevamente.\");\n    }\n  };\n\n  const confirmarFactura = async (datosCobro: {\n    cobrarEstadia: boolean;\n    idsServicios: number[];\n  }) => {\n    if (!detalleFactura || !responsableSeleccionado) return;\n\n    setPaso(\"GUARDANDO\");\n\n    const destinatarioNombre =\n      \"razonSoc\" in responsableSeleccionado\n        ? responsableSeleccionado.razonSoc\n        : `${responsableSeleccionado.apellido}, ${responsableSeleccionado.nombre}`;\n\n    const payload = {\n      idEstadia: detalleFactura.idEstadia,\n      tipoFactura: detalleFactura.tipoFacturaSugerida,\n      destinatario: destinatarioNombre,\n      cobrarAlojamiento: datosCobro.cobrarEstadia,\n      idsConsumosAIncluir: datosCobro.idsServicios,\n      responsableTipo:\n        \"razonSoc\" in responsableSeleccionado ? \"TERCERO\" : \"HUESPED\",\n      responsableId:\n        \"razonSoc\" in responsableSeleccionado\n          ? responsableSeleccionado.cuit\n          : responsableSeleccionado.nroDoc,\n    };\n\n    try {\n      await generarFacturaFinal(payload as any);\n      setPaso(\"EXITO\");\n    } catch (err) {\n      setError(\"Error al generar la factura.\");\n      setPaso(\"COBRANDO\");\n    }\n  };\n\n  return (\n    <div className=\"p-6 min-h-screen bg-[#f5f7fa] dark:bg-gray-950 dark:text-white \">\n      <h1 className=\"text-5xl font-bold text-gray-800 dark:text-white mb-2\">\n        {paso === \"BUSCAR\" && \"Facturar: Check-out\"}\n        {paso === \"GRILLA\" && \"Responsable de pago\"}\n        {paso === \"CARGANDO_CONSUMOS\" && \"Obteniendo consumos...\"}\n        {paso === \"COBRANDO\" && \"Items de la factura\"}\n        {paso === \"GUARDANDO\" && \"Guardando...\"}\n        {paso === \"EXITO\" && \"Factura creada con éxito\"}\n      </h1>\n      <p className=\"dark:text-white mb-8\">\n        {paso === \"BUSCAR\" &&\n          \"Ingrese el número de habitación y el horario de salida para comenzar con la facturación.\"}\n        {paso === \"GRILLA\" &&\n          \"Seleccione un responsable de pago entre los huéspedes.\"}\n        {paso === \"COBRANDO\" &&\n          \"Seleccione los items que quiera colocar en la factura.\"}\n        {paso === \"GUARDANDO\" && \"Generando la factura. Aguarde.\"}\n        {paso === \"EXITO\" &&\n          \"La factura se descargará en breve con el formato elegido.\"}\n      </p>\n      {/* errores */}\n      {error && (\n        <div className=\"bg-red-600 text-white p-4 rounded-xl mb-6 font-bold shadow-md\">\n          {error}\n        </div>\n      )}\n      {/* buscar */}\n      {paso === \"BUSCAR\" && (\n        <div className=\"flex flex-col\">\n          <div\n            id=\"caja-campos\"\n            className=\"flex flex-row gap-4 bg-[#f5f7fa] dark:bg-gray-950 rounded-2xl shadow-sm mb-8\"\n          >\n            <div>\n              <label className=\"block text-md font-bold mb-2\">\n                Nro. de habitación\n              </label>\n              <input\n                type=\"number\"\n                value={id_hab}\n                onChange={(e) => setIdHab(e.target.value)}\n                required\n                className=\"px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-[#f5f7fa] dark:bg-gray-950 focus:ring focus:ring-blue-400 outline-none transition\"\n              />\n            </div>\n            <div>\n              <label className=\"block text-md font-bold mb-2 \">\n                Horario de salida\n              </label>\n              <input\n                type=\"time\"\n                value={hora_checkout}\n                onChange={(e) => setHora(e.target.value)}\n                required\n                className=\"px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-[#f5f7fa] dark:bg-gray-950 focus:ring focus:ring-blue-400 outline-none transition\"\n              />\n            </div>\n          </div>\n\n          <div id=\"caja-botones\" className=\"flex flex-row gap-4\">\n            <button\n              onClick={() => router.push(\"/home\")}\n              className=\"cursor-pointer px-8 py-2 rounded-xl font-bold transition duration-300 dark:border dark:border-white dark:text-white bg-[#f5f7fa] dark:bg-gray-950  text-[#1a252f] border border-[#1a252f] hover:bg-[#b92716] dark:hover:border-[#b92716] hover:text-white hover:border-[#b92716]\"\n            >\n              Cancelar\n            </button>\n            <button\n              onClick={checkOut}\n              className=\"cursor-pointer px-8 py-2 rounded-xl font-bold bg-[#52a173] text-white hover:bg-[#10b655] shadow-lg hover:shadow-xl transition transform active:scale-95\"\n            >\n              Buscar\n            </button>\n          </div>\n        </div>\n      )}\n      {/* seleccionar resp */}\n      {paso === \"GRILLA\" && (\n        <GrillaAlojados\n          idHab={id_hab}\n          horaCheckout={hora_checkout}\n          alojadosDTO={listaAlojados}\n          onSeleccionarResponsable={handleSeleccionResponsable}\n          onAvanzar={avanzarAFacturacion}\n        />\n      )}\n      {/* esperar detalles */}\n      {paso === \"CARGANDO_CONSUMOS\" && (\n        <div className=\"text-center py-10\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto\"></div>\n          <p className=\"mt-4 text-gray-600\">Calculando estadía. Aguarde</p>\n        </div>\n      )}\n\n      {paso === \"COBRANDO\" && detalleFactura && responsableSeleccionado && (\n        <GrillaItemsFactura\n          detalle={detalleFactura}\n          responsableNombre={\n            \"razonSoc\" in responsableSeleccionado\n              ? responsableSeleccionado.razonSoc\n              : `${responsableSeleccionado.nombre} ${responsableSeleccionado.apellido}`\n          }\n          onConfirmar={confirmarFactura}\n          onCancelar={() => setPaso(\"GRILLA\")}\n        />\n      )}\n      {paso === \"GUARDANDO\" && (\n        <div className=\"fixed inset-0 bg-white/50 dark:bg-white/20 dark:text-white flex items-center justify-center z-50\">\n          <h2 className=\"text-5xl font-bold text-black dark:text-white\">\n            Guardando...\n          </h2>\n        </div>\n      )}\n      {/* PASO 4: EXITO */}\n      {paso === \"EXITO\" && (\n        <div className=\"text-center py-20\">\n          <h2 className=\"text-3xl text-green-600 font-bold mb-4\">\n            Operación Exitosa\n          </h2>\n          <button\n            onClick={() => router.push(\"/home\")}\n            className=\"bg-blue-600 text-white px-6 py-2 rounded\"\n          >\n            Volver al inicio\n          </button>\n        </div>\n      )}\n    </div>\n  );\n}\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/hotel-premier/src/app/(app)/facturar/page.tsx b/hotel-premier/src/app/(app)/facturar/page.tsx
--- a/hotel-premier/src/app/(app)/facturar/page.tsx	(revision 98e32783a1e921a1866d9c233de5f2e4539f9b2a)
+++ b/hotel-premier/src/app/(app)/facturar/page.tsx	(date 1766014680630)
@@ -8,6 +8,7 @@
   generarFacturaFinal,
   verificarEstadia,
   obtenerDatosHuesped,
+  descargarFacturaPDF,
 } from "@/services/facturar.service";
 import { DetalleFacturaDTO } from "@/types/facturacion";
 import GrillaAlojados, { ResponsablePago } from "@/components/grilla_alojados";
@@ -36,8 +37,10 @@
 
   const [listaHabitaciones, setListaHabitaciones] = useState<Habitacion[]>([]);
   const [listaAlojados, setListaAlojados] = useState<CriteriosBusq[]>([]);
-  const [responsableSeleccionado, setResponsableSeleccionado] =
-    useState<ResponsablePago | null>(null);
+  const [facturaGenerada, setFacturaGenerada] = useState<any>(null);
+  const [responsableSeleccionado, setResponsableSeleccionado] = useState<
+    ResponsablePago | AlojadoDTO | null
+  >(null);
   const [detalleFactura, setDetalleFactura] =
     useState<DetalleFacturaDTO | null>(null);
 
@@ -104,19 +107,10 @@
         estadia_existe = true;
         console.log(`Response ${response}`);
 
-        setIdEst(response.idEstadia.toString());
-      }
-    } catch (err) {
-      console.error(err);
-      setError("Error al traer los alojados.");
-    }
+        const idEstadia = response.idEstadia.toString();
+        setIdEst(idEstadia);
 
-    if (estadia_existe) {
-      try {
-        // LLAMADA A BACK: obtengo los alojados de una estadía
-        const resp = await buscarAlojados(id_est);
-        // if id hab existe pero lista retorna vacía, entonces no esta ocupada throw error hab no ocupada
-
+        const resp = await buscarAlojados(idEstadia);
         if (!resp || resp.length === 0) {
           setError("La habitación no está ocupada actualmente.");
           return;
@@ -125,10 +119,10 @@
 
         setListaAlojados(resp);
         setPaso("GRILLA");
-      } catch (e) {
-        console.error(e);
-        setError("Error al traer los alojados.");
-      }
+      }
+    } catch (err) {
+      console.error(err);
+      setError("Error al traer los alojados.");
     }
   };
 
@@ -147,7 +141,9 @@
     }
   };
 
-  const handleSeleccionResponsable = (alojado: ResponsablePago) => {
+  const handleSeleccionResponsable = (
+    alojado: ResponsablePago | AlojadoDTO
+  ) => {
     console.log("Responsable seleccionado:", alojado);
     setResponsableSeleccionado(alojado);
     setError(null);
@@ -173,15 +169,17 @@
 
       if (!esMayorDeEdad(huespedCompleto.fechanac)) {
         setError(
-          `El huésped ${responsableSeleccionado.nombre} es menor de edad. Seleccione un adulto o facture a tercero.`
+          `El huésped ${responsableSeleccionado.nombre} no es mayor de edad. Por favor, seleccione otro.`
         );
         return;
       }
 
+      setResponsableSeleccionado(huespedCompleto);
+
       cargarConsumos();
     } catch (err) {
       console.error(err);
-      setError("Error al verificar los datos del huésped. Intente nuevamente.");
+      setError("Error al verificar los datos del huésped");
     }
   };
 
@@ -191,6 +189,12 @@
   }) => {
     if (!detalleFactura || !responsableSeleccionado) return;
 
+    if (!responsableSeleccionado.cuit) {
+      setError(
+        "El responsable seleccionado no tiene CUIT cargado en el sistema."
+      );
+      return;
+    }
     setPaso("GUARDANDO");
 
     const destinatarioNombre =
@@ -206,14 +210,15 @@
       idsConsumosAIncluir: datosCobro.idsServicios,
       responsableTipo:
         "razonSoc" in responsableSeleccionado ? "TERCERO" : "HUESPED",
-      responsableId:
-        "razonSoc" in responsableSeleccionado
-          ? responsableSeleccionado.cuit
-          : responsableSeleccionado.nroDoc,
+      responsableId: responsableSeleccionado.cuit,
     };
+
+    console.log(payload);
 
     try {
-      await generarFacturaFinal(payload as any);
+      const factura = await generarFacturaFinal(payload as any);
+      setFacturaGenerada(factura);
+      await descargarPDF(factura);
       setPaso("EXITO");
     } catch (err) {
       setError("Error al generar la factura.");
@@ -221,6 +226,19 @@
     }
   };
 
+  const descargarPDF = async (factura: any) => {
+    const blob = await descargarFacturaPDF(factura);
+
+    const url = window.URL.createObjectURL(blob);
+    const a = document.createElement("a");
+    a.href = url;
+    a.download = `factura_${factura.num_factura}.pdf`;
+    document.body.appendChild(a);
+    a.click();
+    a.remove();
+    window.URL.revokeObjectURL(url);
+  };
+
   return (
     <div className="p-6 min-h-screen bg-[#f5f7fa] dark:bg-gray-950 dark:text-white ">
       <h1 className="text-5xl font-bold text-gray-800 dark:text-white mb-2">
Index: hotel-premier/src/components/grilla_factura.tsx
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>import React, { useState, useMemo } from \"react\";\nimport { DetalleFacturaDTO } from \"@/types/facturacion\";\n\ninterface Props {\n  detalle: DetalleFacturaDTO;\n  responsableNombre: string;\n  onConfirmar: (payload: {\n    cobrarEstadia: boolean;\n    idsServicios: number[];\n  }) => void;\n  onCancelar: () => void;\n}\n\nexport default function GrillaItemsFactura({\n  detalle,\n  responsableNombre,\n  onConfirmar,\n  onCancelar,\n}: Props) {\n  const [cobrarEstadia, setCobrarEstadia] = useState(true);\n  const [serviciosSeleccionados, setServiciosSeleccionados] = useState<\n    number[]\n  >(detalle.consumos.map((s) => s.idServicio));\n\n  // estado local para el tipo de factura seleccionado (no mutamos la prop)\n  const [tipoFac, setTipoFac] = useState<string>(\n    detalle.tipoFacturaSugerida || \"B\"\n  );\n  const [facturaDistinta, setFacturaDistinta] = useState<boolean>(false);\n\n  const toggleServicio = (id: number) => {\n    setServiciosSeleccionados((prev) =>\n      prev.includes(id) ? prev.filter((i) => i !== id) : [...prev, id]\n    );\n  };\n\n  const totales = useMemo(() => {\n    const totalEstadia = cobrarEstadia ? detalle.costoEstadia : 0;\n\n    const totalServicios = detalle.consumos\n      .filter((s) => serviciosSeleccionados.includes(s.idServicio))\n      .reduce((acc, s) => acc + s.precio * (s.cantidad || 1), 0);\n\n    let subtotal = totalEstadia + totalServicios;\n    let iva = 0;\n    let total = subtotal;\n\n    // solo calcular si es A (usando el tipo seleccionado)\n    if (tipoFac === \"A\") {\n      iva = subtotal * 0.21;\n      total = subtotal + iva;\n    } else {\n      // en B el precio es final\n      iva = 0;\n      total = subtotal;\n    }\n\n    return { subtotal, iva, total };\n  }, [cobrarEstadia, serviciosSeleccionados, detalle, tipoFac]);\n\n  const cambiarTipo = (nuevoTipo: string) => {\n    setTipoFac(nuevoTipo);\n    if (nuevoTipo === detalle.tipoFacturaSugerida) {\n      setFacturaDistinta(false);\n      return;\n    }\n\n    switch (nuevoTipo) {\n      case \"A\":\n        break;\n      case \"B\":\n        break;\n      case \"C\":\n        break;\n      case \"E\":\n        break;\n      default:\n        setTipoFac(\"B\");\n        break;\n    }\n\n    setFacturaDistinta(true);\n  };\n  return (\n    <div className=\"bg-white dark:bg-gray-950 p-6 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 mb-8\">\n      <div className=\"flex flex-row justify-between mb-8\">\n        <div className=\"flex flex-col\">\n          <h2 className=\"text-xl dark:text-white text-black font-semibold\">\n            Seleccione el tipo de factura a generar\n          </h2>\n          <p className=\"text-sm text-gray-500\">\n            Le recomendamos utilizar el tipo de factura sugerido, ya que este se\n            basa en la condición tributaria del destinatario.\n          </p>\n        </div>\n        <div className=\"flex flex-col\">\n          <label className=\"mb-2 text-gray-700 dark:text-gray-400 uppercase text-xs\">\n            Tipo de factura\n          </label>\n          <select\n            name=\"tipoFac\"\n            value={tipoFac}\n            onChange={(e) => cambiarTipo(e.target.value)}\n            className=\"py-1 px-2 text-center border border-blue-600 rounded-lg bg-[#f5f7fa] dark:bg-gray-950 dark:text-white\"\n          >\n            <option value=\"B\">B</option>\n            <option value=\"A\">A</option>\n            <option value=\"C\">C</option>\n            <option value=\"E\">E</option>\n          </select>\n        </div>\n      </div>\n\n      <div className=\"flex justify-between items-center mb-6 border-b pb-4 border-gray-200 dark:border-gray-700\">\n        <div>\n          <h3 className=\"text-xl font-bold text-gray-800 dark:text-white\">\n            Detalle de consumos\n          </h3>\n          <p className=\"text-sm text-gray-500\">\n            Facturar a:{\" \"}\n            <span className=\"font-semibold text-blue-600\">\n              {responsableNombre}\n            </span>\n          </p>\n        </div>\n        <div className=\"text-right flex flex-col\">\n          <div>\n            <span className=\"text-xs uppercase text-gray-400\">\n              Tipo sugerido\n            </span>\n            <div\n              className={`mb-4 text-2xl font-bold border-2 px-3 rounded inline-block ml-2 ${\n                facturaDistinta\n                  ? \"text-gray-400 dark:text-gray-600 border-gray-300 dark:border-gray-600\"\n                  : \"text-blue-500 border-blue-500\"\n              }`}\n            >\n              {detalle.tipoFacturaSugerida}\n            </div>\n\n            {facturaDistinta && (\n              <div className=\"text-right\">\n                <span className=\"text-xs uppercase text-gray-400\">\n                  Tipo seleccionado\n                </span>\n                <div className=\"text-2xl font-bold text-green-400 border-2 border-green-400 px-3 rounded inline-block ml-2\">\n                  {tipoFac}\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n\n      <div className=\"overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700 mb-6\">\n        <table className=\"w-full text-left text-sm\">\n          <thead className=\"bg-gray-100 dark:bg-gray-900 text-gray-600 dark:text-gray-200 uppercase\">\n            <tr>\n              <th className=\"p-3 text-center w-12\">#</th>\n              <th className=\"p-3\">Concepto</th>\n              <th className=\"p-3 text-right\">Monto</th>\n            </tr>\n          </thead>\n          <tbody className=\"divide-y divide-gray-200 dark:divide-gray-700\">\n            <tr\n              className={`cursor-pointer transition hover:bg-blue-50 dark:hover:bg-gray-700 ${\n                cobrarEstadia ? \"bg-blue-50/50 dark:bg-gray-900/50\" : \"\"\n              }`}\n              onClick={() => setCobrarEstadia(!cobrarEstadia)}\n            >\n              <td className=\"p-3 text-center\">\n                <input\n                  type=\"checkbox\"\n                  checked={cobrarEstadia}\n                  readOnly\n                  className=\"rounded text-blue-600 pointer-events-none\"\n                />\n              </td>\n              <td className=\"p-3 font-medium text-gray-800 dark:text-white\">\n                Alojamiento - {detalle.habitacion}\n              </td>\n              <td className=\"p-3 text-right font-semibold text-gray-700 dark:text-gray-300\">\n                ${detalle.costoEstadia.toFixed(2)}\n              </td>\n            </tr>\n\n            {detalle.consumos.map((serv) => (\n              <tr\n                key={serv.idServicio}\n                className={`cursor-pointer transition hover:bg-blue-50 dark:hover:bg-gray-700 ${\n                  serviciosSeleccionados.includes(serv.idServicio)\n                    ? \"bg-blue-50/50 dark:bg-gray-900/50\"\n                    : \"\"\n                }`}\n                onClick={() => toggleServicio(serv.idServicio)}\n              >\n                <td className=\"p-3 text-center\">\n                  <input\n                    type=\"checkbox\"\n                    checked={serviciosSeleccionados.includes(serv.idServicio)}\n                    readOnly\n                    className=\"rounded text-blue-600 pointer-events-none\"\n                  />\n                </td>\n                <td className=\"p-3 text-gray-600 dark:text-gray-300\">\n                  {serv.descripcion || serv.tipoServicio}\n                </td>\n                <td className=\"p-3 text-right text-gray-600 dark:text-gray-300\">\n                  ${serv.precio.toFixed(2)}\n                </td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </div>\n\n      <div className=\"flex flex-col items-end gap-2 text-right\">\n        <div className=\"text-gray-500 dark:text-gray-400\">\n          Subtotal: ${totales.subtotal.toFixed(2)}\n        </div>\n        <div className=\"text-gray-500 dark:text-gray-400\">\n          IVA (21%): ${totales.iva.toFixed(2)}\n        </div>\n        <div className=\"text-2xl font-bold text-gray-800 dark:text-white border-t border-gray-300 dark:border-gray-600 pt-2 w-48\">\n          ${totales.total.toFixed(2)}\n        </div>\n      </div>\n\n      <div className=\"flex justify-end gap-4 mt-6\">\n        <button\n          onClick={onCancelar}\n          className=\"px-4 py-2 text-gray-600 dark:text-white font-semibold hover:bg-red-500 rounded-lg border border-gray-300 transition hover:border-red-500\"\n        >\n          Volver\n        </button>\n        <button\n          disabled={!cobrarEstadia && serviciosSeleccionados.length === 0}\n          onClick={() =>\n            onConfirmar({ cobrarEstadia, idsServicios: serviciosSeleccionados })\n          }\n          className=\"px-6 py-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 shadow-lg transition\"\n        >\n          Confirmar factura\n        </button>\n      </div>\n    </div>\n  );\n}\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/hotel-premier/src/components/grilla_factura.tsx b/hotel-premier/src/components/grilla_factura.tsx
--- a/hotel-premier/src/components/grilla_factura.tsx	(revision 98e32783a1e921a1866d9c233de5f2e4539f9b2a)
+++ b/hotel-premier/src/components/grilla_factura.tsx	(date 1766016708178)
@@ -1,4 +1,4 @@
-import React, { useState, useMemo } from "react";
+import React, { useState, useMemo, useEffect } from "react";
 import { DetalleFacturaDTO } from "@/types/facturacion";
 
 interface Props {
@@ -18,9 +18,10 @@
   onCancelar,
 }: Props) {
   const [cobrarEstadia, setCobrarEstadia] = useState(true);
+
   const [serviciosSeleccionados, setServiciosSeleccionados] = useState<
     number[]
-  >(detalle.consumos.map((s) => s.idServicio));
+  >(detalle?.consumos?.map((s) => s.idServicio) || []);
 
   // estado local para el tipo de factura seleccionado (no mutamos la prop)
   const [tipoFac, setTipoFac] = useState<string>(
Index: hotel-premier/src/types/facturacion.ts
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>// servicio DTO\nexport interface ServicioDTO {\n  idServicio: number;\n  tipoServicio: string;\n  precio: number;\n  descripcion?: string;\n  cantidad?: number;\n}\n\n// DetalleFacturaDTO\nexport interface DetalleFacturaDTO {\n  idEstadia: number;\n  habitacion: string;\n  costoEstadia: number;\n  consumos: ServicioDTO[];\n  montoTotal: number;\n  tipoFacturaSugerida: \"A\" | \"B\" | \"C\" | \"E\";\n}\n\n// POST a generar GenerarFacturaRequestDTO\nexport interface GenerarFacturaRequestDTO {\n  idEstadia: number;\n  tipoFactura: string;\n  // aca depende de si es alojado o persona juridica\n  destinatario: string;\n  cobrarAlojamiento: boolean;\n  idsConsumosAIncluir: number[];\n  responsableId?: string | number;\n  responsableTipo?: \"HUESPED\" | \"TERCERO\";\n}\n\nexport interface CriteriosBusq {\n  nombre: string;\n  apellido: string;\n  tipoDoc: string;\n  nroDoc: string;\n}\n\nexport interface AlojadoDTO extends CriteriosBusq {\n  fechanac: string;\n}\n\nexport interface FacturaDTO {\n  valor: number;\n  servicios: string[];\n  monto: number;\n  tipoFac: string;\n}\n\nexport interface PersonaJuridica {\n  razonSoc: string;\n  cuit: string;\n}\n\nexport interface EstadiaDTO {\n  idEstadia: number;\n  idHabitacion: number;\n  idReserva: number;\n  fechaInicio: string;\n  fechaFin: string;\n  encargado: CriteriosBusq;\n  listaInvitados: CriteriosBusq[];\n}\n
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/hotel-premier/src/types/facturacion.ts b/hotel-premier/src/types/facturacion.ts
--- a/hotel-premier/src/types/facturacion.ts	(revision 98e32783a1e921a1866d9c233de5f2e4539f9b2a)
+++ b/hotel-premier/src/types/facturacion.ts	(date 1766008533133)
@@ -34,10 +34,12 @@
   apellido: string;
   tipoDoc: string;
   nroDoc: string;
+  cuit?: string;
 }
 
 export interface AlojadoDTO extends CriteriosBusq {
   fechanac: string;
+  cuit?: string;
 }
 
 export interface FacturaDTO {
